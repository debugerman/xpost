name: release

on:
  release:
    types:
      - published

permissions:
  contents: write

jobs:
  binaries:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test ./...

      - name: Build release artifacts
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ github.event.release.tag_name }}"
          mkdir -p dist

          build_target() {
            local goos="$1"
            local goarch="$2"
            local ext=""
            if [[ "$goos" == "windows" ]]; then
              ext=".exe"
            fi
            local bin="xpost${ext}"
            local outdir="dist/xpost_${VERSION}_${goos}_${goarch}"
            mkdir -p "$outdir"
            CGO_ENABLED=0 GOOS="$goos" GOARCH="$goarch" go build -trimpath -ldflags="-s -w" -o "${outdir}/${bin}" .
            tar -C "$outdir" -czf "${outdir}.tar.gz" "$bin"
            rm -rf "$outdir"
          }

          build_target linux amd64
          build_target linux arm64
          build_target darwin amd64
          build_target darwin arm64
          build_target windows amd64

          (cd dist && sha256sum ./*.tar.gz > checksums.txt)

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.tar.gz
            dist/checksums.txt
